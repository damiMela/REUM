/*******************************************************************************************************************************//**
 *
 * @file		DR_Systick.h
 * @brief		Funciones para utilización systick timer
 * @date		Sep 19, 2020
 * @author		R2002 - Grupo2
 *
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** INCLUDES
 **********************************************************************************************************************************/
#include <DR/DR_Systick.h>

/***********************************************************************************************************************************
 *** DEFINES PRIVADOS AL MODULO
 **********************************************************************************************************************************/
#define	SYSTICK	((systick_t*) 0xE000E010UL)

/***********************************************************************************************************************************
 *** MACROS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TIPOS DE DATOS PRIVADOS AL MODULO
 **********************************************************************************************************************************/
typedef struct{
	uint32_t Enable:1;
	uint32_t TickInt:1;
	uint32_t ClkSource:1;
	uint32_t __a:13;  //RESERVED
	uint32_t CountFlag:1;
	uint32_t __b:15;
}STCTRL_t;

typedef struct{
	__RW STCTRL_t STCTRL;
	__RW uint32_t STRELOAD;
	__RW uint32_t STCURR;
	__R  uint32_t STCALIB;
}systick_t;

/***********************************************************************************************************************************
 *** TABLAS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PUBLICAS
 **********************************************************************************************************************************/
uint8_t ADC_inUse = 0;
/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PRIVADAS AL MODULO
 **********************************************************************************************************************************/
static uint32_t systickCounter = 0;
/***********************************************************************************************************************************
 *** PROTOTIPO DE FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES GLOBALES AL MODULO
 **********************************************************************************************************************************/
/**
	\fn  inicializarSystick
	\brief Inicializa el systick timer en 10ms
 	\author R2002 - Grupo2
 	\date Sep 19, 2020
*/
void inicializarSystick(void){
	SYSTICK->STRELOAD = SYSTICK->STCALIB/4 -1; //tick cada 2.5ms
	SYSTICK->STCTRL.ClkSource = 1; //clock interno
	SYSTICK->STCURR = 0;
	SYSTICK->STCTRL.TickInt = 1;
	SYSTICK->STCTRL.Enable = 1;
}

/**
	\fn  SysTick_Handler
	\brief handler de la interrupcion. Suma 1 al systickCounter
 	\author R2002 - Grupo2
 	\date Sep 19, 2020
*/
void SysTick_Handler(void){
	TimerDiscount();

	static uint32_t adc_counter = 0;
	adc_counter++;
	adc_counter %= 10;

	if(!adc_counter){
		ADC_startConvertion();
	}

	if(ADC_inUse)
	{

	}
}


/**
	\fn  get_ticks
	\brief fucnión para obtener la cantidad de ticks hechos
 	\author R2002 - Grupo2
 	\date Sep 19, 2020
 	\return valor guardado en systickCounter
*/
uint32_t get_ticks(void){
	return systickCounter;
}


/**
	\fn  get_ticks
	\brief función para resetear la cantidad de ticks
 	\author R2002 - Grupo2
 	\date Sep 19, 2020
 	\return valor guardado en systickCounter
*/
void reset_ticks(void){
	systickCounter = 0;
}
