/*******************************************************************************************************************************//**
 *
 * @file		PR_Botones.c
 * @brief		Descripcion del modulo
 * @date		Oct 27, 2020
 * @author		R2002 - Grupo2
 *
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** INCLUDES
 **********************************************************************************************************************************/
#include <DR/DR_GPIO.h>
#include <PR_Botones.h>
/***********************************************************************************************************************************
 *** DEFINES PRIVADOS AL MODULO
 **********************************************************************************************************************************/
#define CANT_ENTRADAS 5  //MAX:8. Sino cambiar el tipo de variable de buffer y lectura
#define CANT_ACEPT_CYCLES 5
/***********************************************************************************************************************************
 *** MACROS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TIPOS DE DATOS PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TABLAS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PUBLICAS
 **********************************************************************************************************************************/
uint8_t InputBuff = 0;

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PRIVADAS AL MODULO
 **********************************************************************************************************************************/
static uint8_t cycleCounter[CANT_ENTRADAS];
/***********************************************************************************************************************************
 *** PROTOTIPO DE FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES GLOBALES AL MODULO
 **********************************************************************************************************************************/
/**
	\fn  ReadInputs
	\brief lectura y debounce de entradas digitales. Debe estar en el loop
 	\author R2002 - Grupo2
 	\date Oct 27, 2020
*/
void ReadInputs(void){
	uint8_t lectura = 0, input_n, cambios;

	if(getPin(SW1, ON_HIGH)) lectura = (1 << BTN1);
	if(getPin(SW2, ON_HIGH)) lectura |= (1 << BTN2);
	if(getPin(SW3, ON_HIGH)) lectura |= (1 << BTN3);
	if(getPin(SW4, ON_HIGH)) lectura |= (1 << BTN4);
	if(getPin(SW5, ON_HIGH)) lectura |= (1 << BTN5);

	cambios = (InputBuff ^ lectura);

	if(cambios){
		for(input_n = 0; input_n < CANT_ENTRADAS; input_n++){
			if(cambios & (1 << input_n)){
				cycleCounter[input_n]++;	cycleCounter[input_n] %= CANT_ACEPT_CYCLES;

				if(!cycleCounter[input_n])
					InputBuff ^= (1 << input_n);
			}
			else cycleCounter[input_n] = 0;
		}
	}
	else{
		for(input_n=0; input_n < CANT_ENTRADAS; input_n++)
			cycleCounter[input_n] = 0;
	}
}

/**
	\fn  getBtn
	\brief devuelve el estado de uno de los botones (SWx)
 	\author R2002 - Grupo2
 	\date Oct 27, 2020
 	\param [in] número de botón (BTNx)
	\return 1 o 0 según si el botón estaba presionado
*/
uint8_t getBtn(uint8_t n){
	return (InputBuff & (1 << n));
}
