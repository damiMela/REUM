/*******************************************************************************************************************************//**
 *
 * @file		PR_AM2320.c
 * @brief		Descripcion del modulo
 * @date		Dec 20, 2020
 * @author		R2002 - Grupo2
 *
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** INCLUDES
 **********************************************************************************************************************************/
#include <PR/PR_AM2320.h>
#include <PR/PR_I2C.h>
#include <PR/PR_Timers.h>
/***********************************************************************************************************************************
 *** DEFINES PRIVADOS AL MODULO
 **********************************************************************************************************************************/
#define AM2320_ADDR 0x5C

#define AM2320_REG_HUMD 0x00
#define AM2320_REG_TEMP 0x02

#define AM2320_CANT_BYTES 4

#define AM2320_READ		0x03
/***********************************************************************************************************************************
 *** MACROS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TIPOS DE DATOS PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TABLAS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PUBLICAS
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PRIVADAS AL MODULO
 **********************************************************************************************************************************/
static uint8_t ready_read = 0;
/***********************************************************************************************************************************
 *** PROTOTIPO DE FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES GLOBALES AL MODULO
 **********************************************************************************************************************************/
/**
	\fn  Nombre de la Funcion
	\brief Descripcion
 	\author R2002 - Grupo2
 	\date Dec 20, 2020
 	\param [in] parametros de entrada
 	\param [out] parametros de salida
	\return tipo y descripcion de retorno
*/
void timer10ms(void){
	ready_read = 2;
}

void InicializarAM2320(void){
	InicializarI2C();
}

void AM2320_getData(){
	uint8_t rcv[AM2320_CANT_BYTES + 3] = {0};

	if(!ready_read){
		AM2320_wake();

		I2C_beginTransmition(AM2320_ADDR);
		I2C_put(AM2320_READ);
		I2C_put(AM2320_REG_HUMD);
		I2C_put(AM2320_CANT_BYTES);

		I2C_get(AM2320_CANT_BYTES);
		I2C_endTransmition();

		TimerStart(29, 2, timer10ms, CENT);
		ready_read = 1;
	}
	if(ready_read == 2){
		I2C_getData(AM2320_CANT_BYTES + 3, rcv);
		ready_read = 0;
		if(rcv[0]) return;
	}



}

void AM2320_wake(){
	I2C_beginTransmition(AM2320_ADDR);
	I2C_put(0x00);
	I2C_endTransmition();

	for(uint32_t i = 0; i <100000 ; i++);
}
