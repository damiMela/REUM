/*******************************************************************************************************************************//**
 *
 * @file		PR_I2C.c
 * @brief		Descripcion del modulo
 * @date		11 dic. 2020
 * @author		R2002 - Melamed Damian
 *
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** INCLUDES
 **********************************************************************************************************************************/
#include <PR/PR_I2C.h>
#include <DR/DR_I2C.h>
#include <DR/DR_Pinsel.h>
#include <DR/DR_GPIO.h>
/***********************************************************************************************************************************
 *** DEFINES PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** MACROS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TIPOS DE DATOS PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TABLAS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PUBLICAS
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** PROTOTIPO DE FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES GLOBALES AL MODULO
 **********************************************************************************************************************************/
/**
	\fn  Nombre de la Funcion
	\brief Descripcion
 	\author R2002 - Melamed Damian
 	\date 11 dic. 2020
 	\param [in] parametros de entrada
 	\param [out] parametros de salida
	\return tipo y descripcion de retorno
*/
void InicializarI2C(void){
	setPinsel(SDA1,FUNCION_3); //SDA
	setPinsel(SCL1,FUNCION_3);  //SCL

	setPinmode(SDA1, MODE_NONE);
	setPinmode(SCL1, MODE_NONE); //Seteo el Open-drain mode

	setPinmode_OD(SDA1, MODE_OD_NLOW);
	setPinmode_OD(SCL1, MODE_OD_NLOW); //Seteo el Open-drain mode

	InicializarI2C_DR();
}


uint8_t I2C_write(uint8_t address, uint8_t len, uint8_t *msg){
	uint8_t ret = 0;
	if(msg){
		I2C1_WriteLen = len;
		I2C1_ReadLen = 0;

		I2C1_MasterBuff[0] = address * 2; // SLA+W --> address & 0

		for(uint8_t i = 0; i < len; i++){
			I2C1_MasterBuff[i+1] = msg[i];
		}

		if(I2C1_Engine() == I2C_OK) ret = 1;
	}
	return ret;
}

uint8_t I2C_readWrite(uint8_t address, uint8_t wr_len, uint8_t *msg, uint8_t rd_len, uint8_t *data){
	uint8_t ret = 0;
	if(msg){
		I2C1_WriteLen = wr_len+1; //msg + RD bit
		I2C1_ReadLen = rd_len;

		I2C1_MasterBuff[0] = address * 2; // SLA+W --> address & 0
		for(uint8_t i = 0; i < wr_len; i++) I2C1_MasterBuff[i+1] = msg[i];
		I2C1_MasterBuff[wr_len + 1] = (address * 2) + 1; //address & 1

		if(I2C1_Engine() == I2C_OK) ret = 1;

		for(uint8_t j = 0; j < rd_len; j++){
			data[j] = I2C1_SlaveBuff[j];
			I2C1_SlaveBuff[j] = 0;
		}
	}
	return ret;
}

uint8_t I2C_read(uint8_t address, uint8_t reg,  uint8_t len, uint8_t *data){
	uint8_t res = 0;
	if(data){
		I2C1_WriteLen = 2; //msg + RD bit
		I2C1_ReadLen = len;

		I2C1_MasterBuff[0] = address * 2;
		I2C1_MasterBuff[1] = reg;
		I2C1_MasterBuff[2] = (address * 2) + 1;

		I2C1_Engine();

		for(uint8_t i = 0; i < len; i++){
			data[i] = I2C1_SlaveBuff[i];
			I2C1_SlaveBuff[i] = 0;
		}
		res = 1;
	}
	return res;
}
