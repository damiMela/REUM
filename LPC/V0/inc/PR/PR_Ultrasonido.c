/*******************************************************************************************************************************//**
 *
 * @file		PR_Ultrasonido.c
 * @brief		Descripcion del modulo
 * @date		Dec 22, 2020
 * @author		R2002 - Grupo2
 *
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** INCLUDES
 **********************************************************************************************************************************/
#include <PR/PR_Ultrasonido.h>
#include <DR/DR_ExtInt.h>
#include <DR/DR_Timer0.h>

/***********************************************************************************************************************************
 *** DEFINES PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** MACROS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TIPOS DE DATOS PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TABLAS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PUBLICAS
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PRIVADAS AL MODULO
 **********************************************************************************************************************************/
static uint16_t distancia = 0;
/***********************************************************************************************************************************
 *** PROTOTIPO DE FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES GLOBALES AL MODULO
 **********************************************************************************************************************************/
/**
	\fn  Nombre de la Funcion
	\brief Descripcion
 	\author R2002 - Grupo2
 	\date Dec 22, 2020
 	\param [in] parametros de entrada
 	\param [out] parametros de salida
	\return tipo y descripcion de retorno
*/
void InicializarUS(void){
	setDir(US_TRIG_P, OUTPUT);
	//setDir(US_ECHO_P, INPUT);
	setPinmode(US_ECHO_P, FUNCION_1);

	InicializarTimer0_DR();
	InicializarEINT_DR();
}


void updateDistance(void){
	//static uint16_t distancia_buff[10] = {0};

	setPin(US_TRIG_P, LOW);    // LOW
	for (uint16_t i = 200; i; i--);             // for 2µs
	setPin(US_TRIG_P, HIGH);   // HIGH
	for (uint16_t j = 1000; j; j--);             // for 10µs
	setPin(US_TRIG_P, LOW);    // Set LOW again


	EINT2_NO_INTERRUPTS;
	distancia = (uint16_t)((intTime * 10) * (float)343.0 / 20000.0);
	EINT2_INTERRUPTS;
}

uint16_t getUSDistance(void){
	return distancia;
}
