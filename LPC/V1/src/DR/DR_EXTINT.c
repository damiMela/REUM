/*******************************************************************************************************************************//**
 *
 * @file		DR_EXTINT.c
 * @brief		Descripcion del modulo
 * @date		Dec 22, 2020
 * @author		R2002 - Grupo2
 *
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** INCLUDES
 **********************************************************************************************************************************/
#include <DR/DR_EXTINT.h>
#include <DR/DR_Pinsel.h>
#include <DR/DR_GPIO.h>
#include <DR/DR_PLL.h>
#include <PR/PR_Relays.h>
#include <DR/DR_Tipos.h>
/***********************************************************************************************************************************
 *** DEFINES PRIVADOS AL MODULO
 **********************************************************************************************************************************/
#define EINT0		0
#define EINT1		1
#define EINT2		2
#define EINT3		3

#define EINT0_EDGE	0
#define EINT1_EDGE	1
#define EINT2_EDGE	2
#define EINT3_EDGE	3

#define EINT0_POLAR		0
#define EINT1_POLAR		1
#define EINT2_POLAR		2
#define EINT3_POLAR		3


/***********************************************************************************************************************************
 *** MACROS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TIPOS DE DATOS PRIVADOS AL MODULO
 **********************************************************************************************************************************/
#define DIR_EXTINT		((__RW uint32_t *) 0x400FC140UL)
#define DIR_EXTMODE		((__RW uint32_t *) 0x400FC148UL)
#define DIR_EXTPOLAR	((__RW uint32_t *) 0x400FC14CUL)

#define EXTINT		DIR_EXTINT[0]
#define EXTMODE		DIR_EXTMODE[0]
#define EXTPOLAR	DIR_EXTPOLAR[0]

/***********************************************************************************************************************************
 *** TABLAS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PUBLICAS
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** PROTOTIPO DE FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES GLOBALES AL MODULO
 **********************************************************************************************************************************/
/**
	\fn  Nombre de la Funcion
	\brief Descripcion
 	\author R2002 - Grupo2
 	\date Dec 22, 2020
 	\param [in] parametros de entrada
 	\param [out] parametros de salida
	\return tipo y descripcion de retorno
*/
void InicializarEXTINT_DR(void){
	setPinsel(EXPANSION17, FUNCION_1);
	setDir(EXPANSION17, INPUT);
	setPinmode(EXPANSION17, MODE_PULLUP);

	EXTINT |= (1 << EINT2); //clear pending interrupts
	EXTMODE |= (1 << EINT2_EDGE);
	EXTPOLAR |= (1 << EINT2_POLAR); //EINTx -> faling edge
	InicializarRelays();

	ISER0 |= (1 << ISER_EINT0);
	ISER0 |= (1 << ISER_EINT2);
}


void EINT2_IRQHandler (void)
{
	EXTINT |= (1 << EINT2);		/* clear interrupt */

	if ((EXTPOLAR >> EINT2_POLAR) & 0x01)	{
		setRelay(RELAY0, ON);
		EXTPOLAR &= ~(1 << EINT2_POLAR);
	}
	else{
		setRelay(RELAY0, OFF);
		EXTPOLAR |= (1 << EINT2_POLAR);
	}

}
