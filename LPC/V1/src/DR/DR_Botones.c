/*******************************************************************************************************************************//**
 *
 * @file		DR_Botones.c
 * @brief		Descripcion del modulo
 * @date		10 dic. 2020
 * @author		R2002 - Melamed Damian
 *
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** INCLUDES
 **********************************************************************************************************************************/
#include <DR/DR_Botones.h>
#include <DR/DR_GPIO.h>
/***********************************************************************************************************************************
 *** DEFINES PRIVADOS AL MODULO
 **********************************************************************************************************************************/
#define CANTIDAD_REBOTES	5
/***********************************************************************************************************************************
 *** MACROS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TIPOS DE DATOS PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TABLAS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PUBLICAS
 **********************************************************************************************************************************/
volatile uint8_t Botones_buff = 0;
/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** PROTOTIPO DE FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES GLOBALES AL MODULO
 **********************************************************************************************************************************/
/**
	\fn  Nombre de la Funcion
	\brief Descripcion
 	\author R2002 - Melamed Damian
 	\date 10 dic. 2020
 	\param [in] parametros de entrada
 	\param [out] parametros de salida
	\return tipo y descripcion de retorno
*/
uint8_t TecladoHW(void){
	if(getPin(SW1_P, ON_LOW)) return SW1_RAW;
	if(getPin(SW2_P, ON_LOW)) return SW2_RAW;
	if(getPin(SW3_P, ON_LOW)) return SW3_RAW;
	if(getPin(SW4_P, ON_LOW)) return SW4_RAW;
	if(getPin(SW5_P, ON_LOW)) return SW5_RAW;
	return NO_KEY;
}

void TecladoSW(void){
	static uint8_t prev_code = NO_KEY;
	static uint8_t stableState_n = 0;
	uint8_t code = TecladoHW();

	if(code == NO_KEY){
		prev_code = NO_KEY;
		stableState_n = 0;
		return;
	}

	if(stableState_n  == 0){
		prev_code = code;
		stableState_n++;
		return;
	}

	if(stableState_n == CANTIDAD_REBOTES){
		Botones_buff |= (1 << (code-1));
		stableState_n = CANTIDAD_REBOTES+1;
		return;
	}

	if(stableState_n > CANTIDAD_REBOTES) return;

	if(code == prev_code) stableState_n++;
	else stableState_n = 0;
	return;

}


